[gcode_macro MAINTENANCE_TRACKER]
variable_total_print_time: 0
variable_last_extruder_change: 0
variable_last_cleaning: 0
variable_last_dimension_calibration: 0
gcode:
    # Maintenance intervals in hours
    {% set EXTRUDER_CHANGE_INTERVAL = 50 %}
    {% set CLEANING_INTERVAL = 200 %}
    {% set DIMENSION_CALIBRATION_INTERVAL = 500 %}
    
    # Get the print time from the last completed print
    {% set last_print_time = printer.print_stats.print_duration / 3600 %}
    
    # Add the print time to total_print_time
    SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=total_print_time VALUE={self.total_print_time + last_print_time}
    
    # Check each maintenance type
    {% set time_since_extruder_change = self.total_print_time - self.last_extruder_change %}
    {% set time_since_cleaning = self.total_print_time - self.last_cleaning %}
    {% set time_since_dimension_calibration = self.total_print_time - self.last_dimension_calibration %}
    
    # Prepare maintenance messages
    {% set messages = [] %}
    {% if time_since_extruder_change >= EXTRUDER_CHANGE_INTERVAL %}
        {% set messages = messages.append("EXTRUDER CHANGE required (%.2f hours overdue)" % (time_since_extruder_change - EXTRUDER_CHANGE_INTERVAL)) %}
    {% endif %}
    {% if time_since_cleaning >= CLEANING_INTERVAL %}
        {% set messages = messages.append("CLEANING required (%.2f hours overdue)" % (time_since_cleaning - CLEANING_INTERVAL)) %}
    {% endif %}
    {% if time_since_dimension_calibration >= DIMENSION_CALIBRATION_INTERVAL %}
        {% set messages = messages.append("DIMENSION CALIBRATION required (%.2f hours overdue)" % (time_since_dimension_calibration - DIMENSION_CALIBRATION_INTERVAL)) %}
    {% endif %}
    
    # Display maintenance status
    {% if messages %}
        { action_respond_info("MAINTENANCE REQUIRED:\\n" + "\\n".join(messages)) }
    {% else %}
        { action_respond_info("No maintenance required at this time.") }
    {% endif %}
    
    # Log the print time and maintenance status
    { action_respond_info("Last print duration: %.2f hours" % last_print_time) }
    { action_respond_info("Total print time: %.2f hours" % self.total_print_time) }
    { action_respond_info("Time since last extruder change: %.2f hours" % time_since_extruder_change) }
    { action_respond_info("Time since last cleaning: %.2f hours" % time_since_cleaning) }
    { action_respond_info("Time since last dimension calibration: %.2f hours" % time_since_dimension_calibration) }

[gcode_macro RESET_MAINTENANCE]
gcode:
    {% set TASK = params.TASK|default("ALL")|upper %}
    {% if TASK in ["EXTRUDER", "ALL"] %}
        SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_extruder_change VALUE={printer["gcode_macro MAINTENANCE_TRACKER"].total_print_time}
    {% endif %}
    {% if TASK in ["CLEANING", "ALL"] %}
        SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_cleaning VALUE={printer["gcode_macro MAINTENANCE_TRACKER"].total_print_time}
    {% endif %}
    {% if TASK in ["DIMENSION", "ALL"] %}
        SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_dimension_calibration VALUE={printer["gcode_macro MAINTENANCE_TRACKER"].total_print_time}
    {% endif %}
    { action_respond_info("%s maintenance timer(s) have been reset." % (TASK if TASK != "ALL" else "All")) }

[delayed_gcode LOAD_MAINTENANCE_DATA]
initial_duration: 1
gcode:
    {% set svv = printer.save_variables.variables %}
    SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=total_print_time VALUE={svv.total_print_time|default(0)}
    SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_extruder_change VALUE={svv.last_extruder_change|default(0)}
    SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_cleaning VALUE={svv.last_cleaning|default(0)}
    SET_GCODE_VARIABLE MACRO=MAINTENANCE_TRACKER VARIABLE=last_dimension_calibration VALUE={svv.last_dimension_calibration|default(0)}

[delayed_gcode SAVE_MAINTENANCE_DATA]
initial_duration: 60
gcode:
    {% set svv = printer["gcode_macro MAINTENANCE_TRACKER"] %}
    SAVE_VARIABLE VARIABLE=total_print_time VALUE={svv.total_print_time}
    SAVE_VARIABLE VARIABLE=last_extruder_change VALUE={svv.last_extruder_change}
    SAVE_VARIABLE VARIABLE=last_cleaning VALUE={svv.last_cleaning}
    SAVE_VARIABLE VARIABLE=last_dimension_calibration VALUE={svv.last_dimension_calibration}
    UPDATE_DELAYED_GCODE ID=SAVE_MAINTENANCE_DATA DURATION=60
